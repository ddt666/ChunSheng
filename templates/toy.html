<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div>
    <label>DeviceKey</label><input type="text" id="device_key">
    <button onclick="Open_toy()">开启玩具</button>
</div>

<audio autoplay controls id="player" src=""></audio>
<p>消息来自:<span id="from_user"></span></p>

<p>
    <button onclick="start_reco()" style="background-color: yellow">录制声音</button>
    <button onclick="stop_reco_audio()" style="background-color: blue">发送消息</button>
</p>
<p>
    <button onclick="reco_ai()" style="background-color: blue">发送语音指令</button>
</p>
<p>
    <button onclick="recv_msg()" style="background-color: seagreen">收取消息</button>
</p>
</body>
<script src="https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
<script type="application/javascript" src="/static/Recorder.js"></script>
<script type="application/javascript">
    var serv = "http://192.168.1.100:9527";
    var serv_ws = "ws://192.168.1.100:3721/toy/";
    var ws = null;
    var toy_id = null;

    function Open_toy() {
        var device_key = $("#device_key").val();
        $.ajax({
            url: serv + "/device_login",
            type: "POST",
            data: {device_key: device_key},
            success: function (ret) {
                console.log(ret)
                document.getElementById("player").src = serv + "/get_music/" + ret.music;
                toy_id = ret.info;
                ws = new WebSocket(serv_ws + toy_id)
                ws.onmessage = function (data) {
                    console.log(data)
                    var msg = JSON.parse(data.data)
                    if (msg.music) {
                        document.getElementById("player").src = serv + "/get_music/" + msg.music;
                    } else {
                        document.getElementById("player").src = serv + "/get_chat/" + msg.chat;
                        $("#from_user").text(msg.from_user)
                    }


                }
            }

        })

    }

    var reco = null;
    var audio_context = new AudioContext();
    navigator.getUserMedia = (navigator.getUserMedia ||
        navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia ||
        navigator.msGetUserMedia);

    navigator.getUserMedia({audio: true}, create_stream, function (err) {
        console.log(err)
    });

    function create_stream(user_media) {
        var stream_input = audio_context.createMediaStreamSource(user_media);
        console.log("新建")
        reco = new Recorder(stream_input);
    }

    function start_reco() {
        reco.record();
    }


    function stop_reco_audio() {
        reco.stop();
        send_audio();
        reco.clear();
    }

    function reco_ai() {
        reco.stop();
        send_ai();
        reco.clear();
    }

    function send_ai() {
        reco.exportWAV(function (wav_file) {
            var formdata = new FormData();
            formdata.append("record", wav_file);
            formdata.append("from_user", toy_id);
            formdata.append("to_user", document.getElementById("from_user").innerText);
            console.log(formdata);
            $.ajax({
                url: serv + "/ai_uploader",
                type: 'post',
                processData: false,
                contentType: false,
                data: formdata,
                dataType: 'json',
                success: function (data) {
                    $("#from_user").text(data.from_user)
                    if(data.chat){
                        $("#player").attr("src",serv+"/get_chat/"+data.chat)
                    }else{
                         $("#player").attr("src",serv+"/get_music/"+data.music)
                    }

                }
            });

        })
    }

    function send_audio() {
        reco.exportWAV(function (wav_file) {
            var formdata = new FormData();
            formdata.append("record", wav_file);
            formdata.append("from_user", toy_id);
            formdata.append("to_user", document.getElementById("from_user").innerText);
            console.log(formdata);
            $.ajax({
                url: serv + "/toy_uploader",
                type: 'post',
                processData: false,
                contentType: false,
                data: formdata,
                dataType: 'json',
                success: function (data) {
                    if (data.code == 0) {
                        var send_str = {
                            "to_user": document.getElementById("from_user").innerText,
                            "from_user": toy_id,
                            "filename": data.filename
                        }
                        var send_json = JSON.stringify(send_str);
                        ws.send(send_json);
                    }
                }
            });

        })
    }

    function recv_msg() {
        $.ajax({
            url: serv + "/recv_msg",
            type: "POST",
            dataType: "json",
            data: {
                from_user: document.getElementById("from_user").innerText,
                to_user: toy_id
            },
            success: function (ret) {
                console.log(ret)
                if (ret.length > 0) {
                    var player = document.getElementById("player");

                    player.src = serv + "/get_chat/" + ret.shift().msg;
                    player.onended = function () {
                        if (ret.length == 0) {
                            return
                        }
                        player.src = serv + "/get_chat/" + ret.shift().msg;
                    }
                }
            }
        })
    }
</script>
</html>